<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>WEB BEAT : PLAYER</title>
    <style>
        :root { --bg: #000; --accent: #00e5ff; --text: #fff; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; user-select: none; display: flex; justify-content: center; align-items: center; }
        
        #game-view { position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #game-canvas-container { position: relative; width: 450px; height: 100%; border-left: 2px solid #333; border-right: 2px solid #333; box-shadow: 0 0 50px rgba(0,0,0,0.8); background: #000; }
        canvas.game { display: block; width: 100%; height: 100%; }
        
        #game-hud { position: absolute; top: 20px; left: 20px; right: 20px; display: flex; justify-content: space-between; pointer-events: none; z-index: 10; }
        .hud-item { flex: 1; }
        .hud-text { font-family: 'Impact', sans-serif; font-size: 32px; color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.5); letter-spacing: 1px; }
        .hud-sub { font-size: 12px; color: #888; font-weight: bold; }
        #g-avg-box { position: absolute; bottom: 15%; width: 100%; text-align: center; pointer-events: none; }
        #g-avg { font-family: 'Consolas', monospace; font-size: 14px; font-weight: bold; color: #888; text-shadow: 0 0 2px #000; }
        
        #finish-effect { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); width: 100%; text-align: center; pointer-events: none; z-index: 80; }
        .text-fc { font-family: 'Impact', sans-serif; font-size: 60px; color: #00e5ff; text-shadow: 0 0 20px #00e5ff, 0 0 40px #fff; animation: popIn 0.5s forwards; font-style: italic; }
        .text-glitch { position: relative; font-family: 'Impact', sans-serif; font-size: 80px; color: #fff; text-transform: uppercase; letter-spacing: 5px; animation: shake 0.3s infinite; }
        .text-glitch::before, .text-glitch::after { content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; }
        .text-glitch::before { left: 3px; text-shadow: -2px 0 #ff0055; clip-path: polygon(0 0, 100% 0, 100% 30%, 0 30%); animation: glitch-1 2s infinite linear alternate-reverse; }
        .text-glitch::after { left: -3px; text-shadow: -2px 0 #00e5ff; clip-path: polygon(0 40%, 100% 40%, 100% 100%, 0 100%); animation: glitch-2 3s infinite linear alternate-reverse; }
        
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.5); } 100% { opacity: 1; transform: scale(1.2); } }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 100% { transform: translate(-1px, -2px) rotate(-1deg); } }
        @keyframes glitch-1 { 0% { clip-path: inset(20% 0 80% 0); } 100% { clip-path: inset(30% 0 20% 0); } }
        @keyframes glitch-2 { 0% { clip-path: inset(10% 0 60% 0); } 100% { clip-path: inset(10% 0 80% 0); } }

        .res-badge { margin: 10px 0 30px 0; font-size: 40px; font-family: 'Impact'; letter-spacing: 2px; }
        .badge-fc { color: #00e5ff; text-shadow: 0 0 15px #00e5ff; animation: pulse 1s infinite; }
        .badge-ap { color: #ff0055; text-shadow: 2px 2px 0 #fff, 0 0 20px #ff0055; animation: shake 0.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        #result-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 60; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .res-rank { font-family: 'Impact', sans-serif; font-size: 140px; color: #fff; text-shadow: 0 0 30px currentColor; margin-bottom: 10px; line-height: 1; }
        .res-rank.S { color: #00e5ff; } .res-rank.A { color: #00ff00; } .res-rank.B { color: #ffff00; } 
        .res-rank.C { color: #ff8800; } .res-rank.F { color: #ff0000; }
        
        .res-info { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; width: 80%; max-width: 500px; margin-bottom: 30px; }
        .res-box { text-align: center; }
        .res-label { color: #888; font-size: 14px; margin-bottom: 5px; } .res-val { color: #fff; font-size: 24px; font-weight: bold; }
        
        .res-detail { display: flex; justify-content: space-between; width: 90%; max-width: 500px; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; border: 1px solid #333; }
        .detail-item { text-align: center; }
        .detail-label { font-size: 12px; font-weight: bold; margin-bottom: 5px; }
        .detail-val { font-size: 20px; color: #fff; }

        .btn-close { margin-top: 40px; padding: 15px 50px; font-size: 20px; background: #fff; color: #000; border: none; border-radius: 30px; cursor: pointer; font-weight: 900; transition: transform 0.2s; }
        .btn-close:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(255,255,255,0.5); }

        #loading-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 200; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #00e5ff; }
        .loading-text { font-family: 'Impact'; font-size: 40px; margin-bottom: 30px; animation: blink 1s infinite; }
        .btn-start-game { padding: 20px 60px; font-size: 30px; font-weight: bold; background: #ff0055; color: white; border: none; border-radius: 60px; cursor: pointer; display: none; box-shadow: 0 0 30px rgba(255, 0, 85, 0.5); transition: transform 0.2s; }
        .btn-start-game:hover { transform: scale(1.1); }
    </style>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <div id="loading-screen">
        <div class="loading-text" id="loading-msg">INITIALIZING...</div>
        <button id="btn-start-auto" class="btn-start-game" onclick="startGame()">CLICK TO START</button>
    </div>

    <div id="game-view">
        <div id="game-canvas-container">
            <canvas id="gameCanvas" class="game"></canvas>
            <div id="finish-effect"></div>
            <div id="game-hud">
                <div class="hud-item" style="text-align:left"><span class="hud-sub">RATE</span><br><span id="g-rate" class="hud-text">100.00%</span></div>
                <div class="hud-item" style="text-align:center"><span class="hud-sub">SCORE</span><br><span id="g-score" class="hud-text">000000</span></div>
                <div class="hud-item" style="text-align:right"><span class="hud-sub">COMBO</span><br><span id="g-combo" class="hud-text">0</span></div>
            </div>
            <div id="g-avg-box"><div id="g-avg">AVG: 0.0ms</div></div>
            <div id="result-overlay"></div>
        </div>
    </div>

    <script>
        // ==========================================
        // ‚òÖ ÎîîÎ≤ÑÍπÖÏö© Î°úÍ∑∏ Ìï®Ïàò (ÌôîÎ©¥Ïóê ÏÉÅÌÉú ÌëúÏãú)
        // ==========================================
        function logStatus(msg) {
            console.log(msg);
            const el = document.getElementById('loading-msg');
            if(el) el.innerText = msg;
        }

        // ==========================================
        // ‚òÖ [Ï§ëÏöî] ÏÑúÎ≤Ñ Ï£ºÏÜå
        // ==========================================
        const SERVER_URL = "https://port-0-vibecoding-rhythmgame-server-mkgu8rcq7cd54e6c.sel3.cloudtype.app/api/score"; 

        // ==========================================
        // ‚òÖ GOOGLE LOGIN SETUP
        // ==========================================
        const GOOGLE_CLIENT_ID = "143854068141-s09m4p44lfju13dv2gdotoe9hbjfvmmr.apps.googleusercontent.com"; 
        let userProfile = null;
        
        try {
            const stored = localStorage.getItem('wb_auth_profile');
            if (stored) {
                userProfile = JSON.parse(stored);
                console.log("ÏûêÎèô Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ:", userProfile.name);
            }
        } catch(e) { console.error("Login Load Fail", e); }

        window.onload = function() {
            // Íµ¨Í∏Ä ÎùºÏù¥Î∏åÎü¨Î¶¨Í∞Ä Î°úÎìúÎêòÏóàÎäîÏßÄ Ï≤¥ÌÅ¨
            if (typeof google !== 'undefined' && google.accounts && !userProfile) {
                google.accounts.id.initialize({
                    client_id: GOOGLE_CLIENT_ID,
                    callback: handleCredentialResponse
                });
            }
        };

        function handleCredentialResponse(response) {
            const responsePayload = parseJwt(response.credential);
            userProfile = responsePayload;
            localStorage.setItem('wb_auth_profile', JSON.stringify(responsePayload));
            if(gameFinished) showResult();
        }
    
        function parseJwt (token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        // ==========================================
        // ‚òÖ Web Audio API & Sound Load
        // ==========================================
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const soundBuffers = {};

        async function loadSound(name, url) {
            try {
                const response = await fetch(url);
                if(!response.ok) throw new Error(`SFX 404: ${url}`);
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                soundBuffers[name] = audioBuffer;
            } catch (e) { console.warn(`Sound load failed: ${name}`, e); }
        }

        // Ìö®Í≥ºÏùå ÎØ∏Î¶¨ Î°úÎìú (ÎπÑÎèôÍ∏∞)
        loadSound('hit', 'sfx/hit.mp3');
        loadSound('hold_start', 'sfx/hold_start.mp3');
        loadSound('hold_end', 'sfx/hold_end.mp3');
        loadSound('fc', 'sfx/full_combo.mp3');
        loadSound('ap', 'sfx/all_perfect.mp3');

        function playSfx(name) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            if (!soundBuffers[name]) return;
            const source = audioCtx.createBufferSource();
            source.buffer = soundBuffers[name];
            const gainNode = audioCtx.createGain();
            gainNode.gain.value = 0.7; 
            source.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            source.start(0);
        }

        // ==========================================
        //            GAME VARIABLES
        // ==========================================
        let audio = new Audio(); 
        let bpm = 130, offset = 0;
        const BASE_RES = 192; 
        
        const gameCanvas = document.getElementById('gameCanvas');
        const gameCtx = gameCanvas.getContext('2d');
        const finishEffect = document.getElementById('finish-effect');
        const resultOverlay = document.getElementById('result-overlay');
        
        gameCanvas.width = 450;
        gameCanvas.height = window.innerHeight;
        const HIT_LINE_Y = window.innerHeight * 0.85; 
        const TRACK_X_OFFSET = 25; 
        const LANE_WIDTH = 100;
        const NOTE_WIDTH = 90;     
        const NOTE_X_PADDING = 5;  
        const COLORS = ['#FF4081', '#00E676', '#00E676', '#448AFF'];
        
        let gameFinished = false;
        let finishTimer = null;
        let gameState = 'LOADING'; 
        let gameNotes = [], activeNotes = [], particles = [], recentHits = [], judgments = [];
        let activeKeys = [false, false, false, false];
        let combo = 0, maxCombo = 0, totalHits = 0, totalRateSum = 0, totalOffsetDiff = 0, score = 0;
        let gameAnimId, noteSpeed = 5.0;
        let scorePerHit = 0; 
        
        let startTimestamp = 0;
        const START_DELAY = 2000; 
        let lastNoteEndTime = 0; 
        let totalMaxHits = 0; 
        let judgeStats = { perfect: 0, great: 0, okay: 0, oh: 0, miss: 0 };

        window.addEventListener('resize', () => { gameCanvas.height = window.innerHeight; });

        audio.onended = () => {
            if (!gameFinished) finishGame();
        };

        // ‚òÖ [ÏàòÏ†ï] DOMContentLoaded Î°úÏßÅ Í∞ïÌôî
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const song = urlParams.get('song');
            const diff = urlParams.get('diff');
            const speed = urlParams.get('speed');

            // 1. URL ÌååÎùºÎØ∏ÌÑ∞ Ï≤¥ÌÅ¨
            if (!song || !diff) {
                logStatus("ERROR: NO SONG DATA");
                alert("ÏûòÎ™ªÎêú Ï†ëÍ∑ºÏûÖÎãàÎã§. Í≥°ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
                location.href = "index.html"; // Î©îÏù∏ÏúºÎ°ú ÌäïÍ≤®ÎÇ¥Í∏∞
                return;
            }

            // 2. ÌååÏùº ÌîÑÎ°úÌÜ†ÏΩú Ï≤¥ÌÅ¨
            if (window.location.protocol === 'file:') {
                logStatus("ERROR: FILE PROTOCOL");
                alert("Î≥¥Ïïà Ïò§Î•ò: file:// ÏóêÏÑúÎäî Ïã§ÌñâÌï† Ïàò ÏóÜÏäµÎãàÎã§.\nLive ServerÎ•º ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî.");
                return;
            }

            if(speed) noteSpeed = parseFloat(speed);
            const userGlobalOffset = parseInt(localStorage.getItem('wb_global_offset') || 0);
            offset += userGlobalOffset;
            
            // Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÏûë
            loadGameData(song, diff);
        });

        async function loadGameData(song, diff) {
            const startBtn = document.getElementById('btn-start-auto');
            const loadingMsg = document.getElementById('loading-msg');
            
            try {
                // 1. Ï∞®Ìä∏ JSON Î°úÎìú
                logStatus("LOADING CHART...");
                const chartRes = await fetch(`Maps/${song}/${diff}.json`);
                if(!chartRes.ok) throw new Error(`Chart File Not Found: ${song}/${diff}`);
                const chartData = await chartRes.json();
                parseChartData(chartData);

                // 2. Ïò§ÎîîÏò§ Î°úÎìú (Ï∫êÏãú Î¨∏Ï†ú Ìï¥Í≤∞ Î≤ÑÏ†Ñ)
                logStatus("LOADING AUDIO...");
                const audioPath = `Maps/${song}/audio.mp3`;

                // ‚òÖ [ÌïµÏã¨] Ïò§ÎîîÏò§ Ï§ÄÎπÑ ÏôÑÎ£å Ï≤¥ÌÅ¨ Ìï®Ïàò
                const checkAudioReady = () => {
                    // readyState 4(HAVE_ENOUGH_DATA) ÎòêÎäî 3(HAVE_FUTURE_DATA)Ïù¥Î©¥ Ï§ÄÎπÑ Îêú Í≤ÉÏûÑ
                    if (audio.readyState >= 3) {
                        console.log("Audio Loaded (Cached or Downloaded)");
                        logStatus("READY");
                        loadingMsg.style.display = 'none'; 
                        startBtn.style.display = 'block';
                        return true;
                    }
                    return false;
                };

                // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù
                audio.oncanplaythrough = checkAudioReady;
                audio.onloadeddata = checkAudioReady; // ÌòπÏãú Î™∞Îùº ÌïòÎÇò Îçî Îì±Î°ù
                
                audio.onerror = (e) => {
                    logStatus("AUDIO ERROR");
                    alert("Ïò§ÎîîÏò§ ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§: " + audioPath);
                };

                audio.src = audioPath;
                audio.load();

                // ‚òÖ [Í∞ïÎ†•Ìïú ÏïàÏ†ÑÏû•Ïπò] 
                // Ïù¥ÎØ∏ Ï∫êÏãúÎêòÏñ¥ÏÑú Ïù¥Î≤§Ìä∏Í∞Ä Ïïà ÌÑ∞Ïßà Í≤ΩÏö∞Î•º ÎåÄÎπÑÌï¥, 
                // 0.1Ï¥àÎßàÎã§ Í≤ÄÏÇ¨Ìï¥ÏÑú Ï§ÄÎπÑÎêêÏúºÎ©¥ Í∞ïÏ†úÎ°ú ÎÑòÍ≤®Î≤ÑÎ¶º
                const forceCheck = setInterval(() => {
                    if (checkAudioReady()) {
                        clearInterval(forceCheck); // Ï§ÄÎπÑÎêêÏúºÎ©¥ Í≤ÄÏÇ¨ Ï¢ÖÎ£å
                    }
                }, 100);

            } catch (err) { 
                console.error(err);
                logStatus("ERROR: " + err.message);
                alert(`Ïò§Î•ò Î∞úÏÉù: ${err.message}`); 
                window.location.href = "index.html"; 
            }
        }

        function parseChartData(data) {
            if(data.bpm) bpm = data.bpm;
            if(data.offset) offset += (data.offset || 0); 
            gameNotes = []; totalMaxHits = 0;
            
            if(data.measures) {
                const msPerMeasure = (60000 / bpm) * 4;
                data.measures.forEach(m => {
                    const ratio = BASE_RES / (m.split || 32); 
                    m.notes.forEach(n => {
                        const time = (m.index + (n.pos * ratio / BASE_RES)) * msPerMeasure;
                        const duration = ((n.len || 0) * ratio / BASE_RES) * msPerMeasure;
                        
                        const noteTime = time + offset; 
                        const noteEndTime = noteTime + duration;
                        
                        if (noteEndTime > lastNoteEndTime) lastNoteEndTime = noteEndTime;
                        
                        gameNotes.push({ time: noteTime, endTime: noteEndTime, lane: n.lane, len: (n.len || 0) * ratio, hit: false, holding: false, finished: false });
                        
                        totalMaxHits++; 
                        if(n.len > 0) totalMaxHits++; 
                    });
                });
            }
            gameNotes.sort((a,b) => a.time - b.time);
            scorePerHit = totalMaxHits > 0 ? (1000000 / totalMaxHits) : 0;
        }

        function startGame() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            document.getElementById('loading-screen').style.display = 'none';
            combo = 0; maxCombo = 0; totalHits = 0; totalRateSum = 0; totalOffsetDiff = 0; score = 0;
            judgeStats = { perfect: 0, great: 0, okay: 0, oh: 0, miss: 0 };
            activeNotes = []; particles = []; recentHits = []; judgments = [];
            finishEffect.innerHTML = "";
            updateGameHUD();
            
            gameState = 'COUNTDOWN';
            startTimestamp = Date.now(); // Í≤åÏûÑ ÏãúÏûë Í∏∞Ï§Ä ÏãúÍ∞Ñ Ï¥àÍ∏∞Ìôî
            audio.currentTime = 0;
            
            setTimeout(finishGame, (2000 + lastNoteEndTime + 5000));

            gameLoop();
        }

        function finishGame() {
            if (gameFinished) return;
            gameFinished = true;
            console.log("Game Finished!");
            audio.pause();
            showResult();
        }

        function gameLoop() {
            if(gameFinished) return;
            gameAnimId = requestAnimationFrame(gameLoop);
            
            const now = Date.now();
            const rawTime = now - startTimestamp;
            let currentTime = -9999;

            if (gameState === 'COUNTDOWN') {
                currentTime = rawTime - START_DELAY;
                if (rawTime >= START_DELAY) {
                    gameState = 'WAIT_AUDIO';
                    // Ïò§ÎîîÏò§ ÌîåÎ†àÏù¥ ÏãúÎèÑ
                    const playPromise = audio.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            console.log("Audio Play Failed (Autoplay policy):", error);
                            // ÏûêÎèô Ïû¨ÏÉù Ïã§Ìå® Ïãú Í∞ïÏ†úÎ°ú ÏãúÍ∞ÑÏúºÎ°ú ÏßÑÌñâ
                            gameState = 'PLAYING_NO_AUDIO'; 
                        });
                    }
                }
            } else if (gameState === 'WAIT_AUDIO') {
                currentTime = 0;
                if (audio.currentTime > 0 && !audio.paused) gameState = 'PLAYING';
            } else if (gameState === 'PLAYING') {
                currentTime = audio.currentTime * 1000;
            } else if (gameState === 'PLAYING_NO_AUDIO') {
                // Ïò§ÎîîÏò§ ÏóÜÏù¥ ÏßÑÌñâ (Î∞±ÏóÖ)
                currentTime = (Date.now() - startTimestamp) - START_DELAY;
            }

            if (!gameFinished && totalHits >= totalMaxHits) {
                if (!finishTimer) {
                    finishTimer = setTimeout(finishGame, 1000); 
                }
            }

            gameCtx.fillStyle = '#000'; gameCtx.fillRect(0, 0, 450, gameCanvas.height);
            drawLaneBeams();
            drawJudgmentLine();

            const NOTE_SPEED_PX = 100 * noteSpeed; 
            while(gameNotes.length > 0 && gameNotes[0].time - 2000 < currentTime) activeNotes.push(gameNotes.shift());

            for(let i=0; i<activeNotes.length; i++) {
                let n = activeNotes[i];
                const timeDiff = n.time - currentTime;
                const headY = HIT_LINE_Y - (timeDiff / 1000 * NOTE_SPEED_PX);
                let tailY = headY;
                if (n.len > 0) tailY = HIT_LINE_Y - ((n.endTime - currentTime) / 1000 * NOTE_SPEED_PX);

                if (tailY > gameCanvas.height) {
                    if (!n.finished) {
                        n.finished = true;
                        if (!n.hit) {
                            n.hit = true; 
                            combo = 0; totalHits++; judgeStats.miss++; 
                            if(n.len > 0) totalHits++; 
                            updateGameHUD(); showJudge("No..", n.lane, "#ff5555");
                        }
                    }
                    continue; 
                }

                if(!n.hit && !n.finished && currentTime > n.time + 250) { 
                    n.hit = true; n.finished = true; 
                    combo = 0; totalHits++; judgeStats.miss++; 
                    if(n.len > 0) totalHits++; 
                    updateGameHUD(); showJudge("No..", n.lane, "#ff5555");
                    checkFinish();
                }

                if (n.hit && n.len > 0 && !n.finished) {
                    if (activeKeys[n.lane]) {
                        if (currentTime >= n.endTime) {
                            n.finished = true; totalHits++; score += scorePerHit; 
                            totalRateSum += 100; combo++; judgeStats.perfect++; 
                            updateGameHUD(); createParticles(n.lane); playSfx('hold_end'); checkFinish();
                        }
                    }
                }

                if (!n.finished) {
                    const laneX = TRACK_X_OFFSET + (n.lane * LANE_WIDTH);
                    if (n.len > 0) {
                        const drawHeadY = n.hit ? HIT_LINE_Y : headY;
                        const bodyH = drawHeadY - tailY;
                        if (drawHeadY > -50 && tailY < gameCanvas.height) {
                            gameCtx.fillStyle = "rgba(255, 255, 255, 0.5)";
                            gameCtx.fillRect(laneX + NOTE_X_PADDING, tailY, NOTE_WIDTH, bodyH);
                        }
                    }
                    if (!n.hit && headY > -50 && headY < gameCanvas.height) {
                        gameCtx.fillStyle = COLORS[n.lane]; 
                        gameCtx.fillRect(laneX + NOTE_X_PADDING, headY - 15, NOTE_WIDTH, 30);
                        gameCtx.fillStyle = "rgba(255,255,255,0.7)"; 
                        gameCtx.fillRect(laneX + NOTE_X_PADDING, headY - 15, NOTE_WIDTH, 8);
                    }
                }
            }
            activeNotes = activeNotes.filter(n => !n.finished);
            drawParticles(); drawGameFX(); drawHitErrorBar();
        }

        const KEY_MAP = ['d', 'f', 'j', 'k'];
        window.addEventListener('keydown', e => {
            if(gameFinished) return;
            const lane = KEY_MAP.indexOf(e.key.toLowerCase());
            if(lane !== -1 && !activeKeys[lane]) { activeKeys[lane] = true; checkHit(lane); }
        });
        window.addEventListener('keyup', e => {
            if(gameFinished) return;
            const lane = KEY_MAP.indexOf(e.key.toLowerCase());
            if(lane !== -1) { activeKeys[lane] = false; checkRelease(lane); }
        });

        function checkHit(lane) {
            let currentTime = 0;
            if (gameState === 'PLAYING' && audio.currentTime > 0) currentTime = audio.currentTime * 1000;
            else currentTime = (Date.now() - startTimestamp) - START_DELAY;

            const HIT_WINDOW = 250; 
            const candidates = activeNotes.filter(n => n.lane === lane && !n.hit && !n.finished && Math.abs(currentTime - n.time) <= HIT_WINDOW);
            if (candidates.length === 0) return;

            const n = candidates.reduce((prev, curr) => Math.abs(currentTime - curr.time) < Math.abs(currentTime - prev.time) ? curr : prev);
            const absDiff = Math.abs(currentTime - n.time);

            n.hit = true; n.holding = true; if (n.len === 0) n.finished = true;
            totalHits++; 
            if (typeof playSfx === 'function') { if (n.len > 0) playSfx('hold_start'); else playSfx('hit'); }

            let judge="No..", clr="#888", rate=0;
            if(absDiff <= 32) { judge="PERFECT"; clr="#00e5ff"; rate=100; judgeStats.perfect++; }
            else if(absDiff <= 64) { judge="GREAT"; clr="#00ff00"; rate=90; judgeStats.great++; }
            else if(absDiff <= 96) { judge="OKAY"; clr="#ffff00"; rate=50; judgeStats.okay++; }
            else { judge="OH..."; clr="#ff5555"; rate=10; judgeStats.oh++; }

            if(rate > 0) { combo++; if(combo > maxCombo) maxCombo = combo; score += (rate / 100) * scorePerHit; createParticles(lane); } 
            else { combo = 0; }
            
            totalRateSum += rate; updateGameHUD(); showJudge(judge, lane, clr); 
            recentHits.push({ diff: currentTime - n.time, color: clr, life: 600, maxLife: 600 });
            if(n.finished) checkFinish();
        }

        function checkRelease(lane) {
            const n = activeNotes.find(n => n.lane === lane && n.hit && !n.finished && n.len > 0);
            if (n) {
                let currentTime = 0;
                if (gameState === 'PLAYING' && audio.currentTime > 0) currentTime = audio.currentTime * 1000;
                else currentTime = (Date.now() - startTimestamp) - START_DELAY;

                const remaining = n.endTime - currentTime; 
                const totalDuration = n.endTime - n.time;
                const safeZone = Math.max(300, totalDuration * 0.5); 
                
                if (remaining > safeZone) { 
                    n.finished = true; combo = 0; totalHits++; judgeStats.miss++; updateGameHUD(); showJudge("No..", lane, "#555");
                } else {
                    n.finished = true; totalHits++; score += scorePerHit; totalRateSum += 100; combo++; judgeStats.perfect++; 
                    createParticles(lane); updateGameHUD(); showJudge("PERFECT", lane, "#00e5ff"); playSfx('hold_end');
                }
                checkFinish();
            }
        }

        function updateGameHUD() {
            document.getElementById('g-combo').innerText = combo;
            document.getElementById('g-score').innerText = Math.round(score).toString().padStart(6, '0');
            let currentRate = 100.00;
            if (totalHits > 0) {
                currentRate = Math.min(100, (totalRateSum / (totalHits * 100)) * 100);
            }
            document.getElementById('g-rate').innerText = currentRate.toFixed(2) + "%";
        }

        function drawJudgmentLine() {
            gameCtx.shadowBlur = 10; gameCtx.shadowColor = '#00e5ff'; gameCtx.strokeStyle = '#00e5ff'; gameCtx.lineWidth = 3;
            gameCtx.beginPath(); gameCtx.moveTo(0, HIT_LINE_Y); gameCtx.lineTo(450, HIT_LINE_Y); gameCtx.stroke(); gameCtx.shadowBlur = 0;
            gameCtx.strokeStyle = '#333'; gameCtx.lineWidth = 2;
            for(let i=0; i<=4; i++) { gameCtx.beginPath(); const x = TRACK_X_OFFSET + i*100; gameCtx.moveTo(x, 0); gameCtx.lineTo(x, gameCanvas.height); gameCtx.stroke(); }
        }

        function drawLaneBeams() {
            gameCtx.globalCompositeOperation = 'lighter';
            for(let i=0; i<4; i++) { 
                if(activeKeys[i]) { 
                    const grd = gameCtx.createLinearGradient(0, HIT_LINE_Y, 0, HIT_LINE_Y - 300); 
                    grd.addColorStop(0, COLORS[i] + '80'); grd.addColorStop(1, "transparent"); 
                    gameCtx.fillStyle=grd; gameCtx.fillRect(TRACK_X_OFFSET + i*100, 0, 100, HIT_LINE_Y); 
                } 
            }
            gameCtx.globalCompositeOperation = 'source-over';
        }

        function showJudge(text, lane, color) { judgments.push({text, x: TRACK_X_OFFSET + lane*100 + 50, y: HIT_LINE_Y - 50, life: 30, maxLife: 30, color}); }
        function createParticles(lane) { for(let i=0; i<8; i++) particles.push({x:TRACK_X_OFFSET + lane*100+50, y:HIT_LINE_Y, vx:(Math.random()-0.5)*15, vy:(Math.random()-1)*15, life:1.0, color:COLORS[lane]}); }
        
        function drawGameFX() {
            for(let i=judgments.length-1; i>=0; i--) {
                const j = judgments[i]; gameCtx.save(); gameCtx.globalAlpha = j.life/j.maxLife; gameCtx.fillStyle = j.color; 
                gameCtx.font="900 24px Arial"; gameCtx.textAlign="center"; gameCtx.fillText(j.text, j.x, j.y - (30 - j.life)); 
                gameCtx.restore(); j.life--; if(j.life<=0) judgments.splice(i,1);
            }
        }
        function drawHitErrorBar() {
            const cx = 225, cy = HIT_LINE_Y + 40, width = 300;
            gameCtx.fillStyle = "rgba(100, 100, 100, 0.5)"; gameCtx.fillRect(cx - width/2, cy - 2, width, 4);
            gameCtx.fillStyle = "#fff"; gameCtx.fillRect(cx - 1, cy - 6, 2, 12);
            for(let i = recentHits.length - 1; i >= 0; i--) {
                const h = recentHits[i]; const px = (h.diff / 150) * (width / 2); 
                let drawX = Math.max(cx - width/2, Math.min(cx + width/2, cx + px));
                gameCtx.fillStyle = h.color; gameCtx.globalAlpha = h.life / h.maxLife;
                gameCtx.fillRect(drawX - 2, cy - 6, 4, 12);
                gameCtx.globalAlpha = 1.0; h.life--; if(h.life <= 0) recentHits.splice(i, 1);
            }
        }
        function drawParticles() { for(let i=particles.length-1; i>=0; i--){ let p=particles[i]; p.x+=p.vx; p.y+=p.vy; p.vy+=0.8; p.life-=0.05; if(p.life<=0) particles.splice(i,1); else { gameCtx.globalAlpha=p.life; gameCtx.fillStyle=p.color; gameCtx.fillRect(p.x,p.y,6,6); } } gameCtx.globalAlpha=1.0; }

        function checkFinish() {
            if (totalHits >= totalMaxHits && totalMaxHits > 0) {
                if (judgeStats.perfect === totalMaxHits) { finishEffect.innerHTML = "<div class='text-glitch' data-text='TROLL BEAT!!'>TROLL BEAT!!</div>"; playSfx('ap'); }
                else if (combo === totalMaxHits) { finishEffect.innerHTML = "<div class='text-fc'>FULL COMBO</div>"; playSfx('fc'); }
            }
        }

        // ==========================================
        // ‚òÖ [FIX] Ï†ÄÏû• ÌÉÄÏù¥Î∞ç Î¨∏Ï†ú Ìï¥Í≤∞Îêú showResult
        // ==========================================
        async function showResult() {
            try {
                // 1. Ï£ºÏÜå Î≥ÄÏàò Ï§ÄÎπÑ
                const SERVER_BASE = SERVER_URL.replace('/api/score', '');

                finishEffect.innerHTML = "";
                let finalRate = 0; if(totalHits > 0) finalRate = (totalRateSum / (totalHits * 100)) * 100;

                // ==========================================
                // ‚òÖ Í≤ΩÌóòÏπò(XP) & Î†àÎ≤® Í≥ÑÏÇ∞
                // ==========================================
                let gainedXp = Math.floor(score / 5000); 
                if (combo === totalMaxHits && totalMaxHits > 0) gainedXp += 50; 

                let currentLv = parseInt(localStorage.getItem('wb_user_lv') || "1");
                let currentXp = parseInt(localStorage.getItem('wb_user_xp') || "0");

                currentXp += gainedXp;
                let requiredXp = currentLv * 500; 
                while (currentXp >= requiredXp) {
                    currentXp -= requiredXp; 
                    currentLv++;            
                    requiredXp = currentLv * 500; 
                }

                // ÎÇ¥ Ïª¥Ìì®ÌÑ∞Ïóê ÏµúÏã† ÏÉÅÌÉú Ï†ÄÏû•
                localStorage.setItem('wb_user_lv', currentLv);
                localStorage.setItem('wb_user_xp', currentXp);

                // Îû≠ÌÅ¨ Í≥ÑÏÇ∞
                let rank = "F"; if(finalRate >= 95) rank = "S"; else if(finalRate >= 90) rank = "A"; else if(finalRate >= 80) rank = "B"; else if(finalRate >= 70) rank = "C";
                const finalScore = Math.round(score).toString().padStart(6, '0');
                
                const urlParams = new URLSearchParams(window.location.search);
                const songParam = urlParams.get('song');
                const diffParam = urlParams.get('diff');

                // ==========================================
                // ‚òÖ ÎÇ¥ Ïª¥Ìì®ÌÑ∞Ïóê Î±ÉÏßÄ & ÏµúÍ≥†Ï†êÏàò Ï†ÄÏû•
                // ==========================================
                if (songParam && diffParam) {
                    const scoreKey = `wb_score_${songParam}_${diffParam}`;
                    const badgeKey = `wb_badge_${songParam}_${diffParam}`;
                    
                    const savedScore = parseInt(localStorage.getItem(scoreKey) || "0");
                    const currentScore = Math.round(score);
                    if (currentScore > savedScore) localStorage.setItem(scoreKey, currentScore.toString().padStart(6, '0'));

                    if (judgeStats.perfect === totalMaxHits && totalMaxHits > 0) localStorage.setItem(badgeKey, "TB");
                    else if (combo === totalMaxHits && totalMaxHits > 0) {
                        if (localStorage.getItem(badgeKey) !== "TB") localStorage.setItem(badgeKey, "FC");
                    }
                }
                
                // ==========================================
                // ‚òÖ [ÏÑúÎ≤Ñ Ï†ÑÏÜ°] awaitÎ•º Ïç®ÏÑú "Ï†ÄÏû• ÏôÑÎ£å"Î•º Í∏∞Îã§Î¶º
                // ==========================================
                if (songParam && diffParam && userProfile) { 
                    try {
                        // 1. Ï†êÏàò Ï†ÄÏû• Í∏∞Îã§Î¶¨Í∏∞ (await)
                        await fetch(`${SERVER_BASE}/api/score`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                userId: userProfile.sub,
                                userName: userProfile.name,
                                song: songParam,
                                diff: diffParam,
                                score: Math.round(score),
                                level: currentLv
                            })
                        });
                        console.log("ÏÑúÎ≤Ñ Ï†ÄÏû• ÏôÑÎ£å!");

                        // 2. XP Ï†ÄÏû• Í∏∞Îã§Î¶¨Í∏∞ (await)
                        await fetch(`${SERVER_BASE}/api/user/update`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                userId: userProfile.sub,
                                level: currentLv,
                                xp: currentXp
                            })
                        });
                    } catch (err) {
                        console.error("ÏÑúÎ≤Ñ Ï†ÑÏÜ° Ï§ë ÏóêÎü¨:", err);
                    }
                } else {
                    console.log("Í≤åÏä§Ìä∏ Î™®Îìú: ÏÑúÎ≤Ñ Ï†ÄÏû• Í±¥ÎÑàÎúÄ");
                }

                // ==========================================
                // ‚òÖ Îû≠ÌÇπ Í∞ÄÏ†∏Ïò§Í∏∞ (Ï†ÄÏû•Ïù¥ ÎÅùÎÇú Îí§Ïóê Ïã§ÌñâÎê®!)
                // ==========================================
                let rankingHtml = "<div style='color:#888; margin-top:10px;'>LOADING RANKING...</div>";
                try {
                    const res = await fetch(`${SERVER_BASE}/api/ranking/${songParam}/${diffParam}`);
                    const rankData = await res.json();
                    
                    if(rankData.length > 0) {
                        rankingHtml = `<div style="margin-top:20px; width:100%; max-width:400px; border:1px solid #444; border-radius:10px; padding:10px; background:rgba(0,0,0,0.5);">
                            <div style="color:#00e5ff; font-weight:bold; margin-bottom:10px;">üèÜ TOP 5 PLAYERS</div>`;
                        
                        rankData.slice(0, 5).forEach((r, idx) => {
                            const medal = idx === 0 ? "ü•á" : idx === 1 ? "ü•à" : idx === 2 ? "ü•â" : `#${idx+1}`;
                            const isMe = userProfile && r.userId === userProfile.sub ? "color:#ffd700;" : "color:#fff;";
                            rankingHtml += `
                                <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:14px; ${isMe}">
                                    <span>${medal} ${r.userName}</span>
                                    <span>${r.score}</span>
                                </div>`;
                        });
                        rankingHtml += `</div>`;
                    } else {
                        rankingHtml = "<div style='color:#666; margin-top:20px;'>BE THE FIRST CHALLENGER!</div>";
                    }
                } catch(e) { console.warn("Ranking Load Fail", e); }


                // 3. Í≤∞Í≥ºÏ∞Ω HTML Ï°∞Î¶Ω
                let badgeHtml = "";
                if (judgeStats.perfect === totalMaxHits && totalMaxHits > 0) 
                    badgeHtml = "<div class='res-badge badge-ap'>ALL PERFECT</div>";
                else if (combo === totalMaxHits && totalMaxHits > 0) 
                    badgeHtml = "<div class='res-badge badge-fc'>FULL COMBO</div>";

                resultOverlay.innerHTML = `
                    <div style="text-align:center; margin-bottom:10px;">
                        <div style="color:#aaa; font-size:16px; letter-spacing:2px; margin-bottom:5px;">RESULT</div>
                        <div class="${rank} res-rank">${rank}</div>
                    </div>
                    ${badgeHtml}
                    <div class="res-info">
                        <div class="res-box"><div class="res-label">SCORE</div><div class="res-val">${finalScore}</div></div>
                        <div class="res-box"><div class="res-label">RATE</div><div class="res-val">${finalRate.toFixed(2)}%</div></div>
                        <div class="res-box"><div class="res-label">MAX COMBO</div><div class="res-val">${maxCombo}</div></div>
                    </div>

                    <div class="res-detail" style="margin-bottom:20px;">
                        <div class="detail-item"><div class="detail-label" style="color:#00e5ff">PERFECT</div><div class="detail-val">${judgeStats.perfect}</div></div>
                        <div class="detail-item"><div class="detail-label" style="color:#00ff00">GREAT</div><div class="detail-val">${judgeStats.great}</div></div>
                        <div class="detail-item"><div class="detail-label" style="color:#ffff00">OKAY</div><div class="detail-val">${judgeStats.okay}</div></div>
                        <div class="detail-item"><div class="detail-label" style="color:#ff5555">OH...</div><div class="detail-val">${judgeStats.oh}</div></div>
                        <div class="detail-item"><div class="detail-label" style="color:#888">No..</div><div class="detail-val">${judgeStats.miss}</div></div>
                    </div>
                    
                    ${rankingHtml}

                    <div id="google-login-btn-result" style="margin-top: 15px; display: flex; justify-content: center; min-height:40px;"></div>

                    <button class="btn-close" onclick="location.href='index.html'" style="margin-top:20px;">CONTINUE</button>
                `;
                
                resultOverlay.style.display = 'flex';

                if (!userProfile) {
                    google.accounts.id.renderButton(
                        document.getElementById("google-login-btn-result"),
                        { theme: "filled_black", size: "large", shape: "pill" }
                    );
                }

            } catch(e) {
                alert("Result Error: " + e.message);
                location.href='index.html';
            }
        }
    </script>
</body>
</html>