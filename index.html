<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>WEB BEAT : SELECT</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Exo+2:wght@300;600&display=swap');
        
        :root {
            --bg-dark: #050505;
            --panel-glass: rgba(22, 22, 30, 0.8);
            --accent: #00f2ff;
            --accent-glow: rgba(0, 242, 255, 0.6);
            --secondary: #7000ff;
            --text-main: #ffffff;
            --text-dim: #888888;
            --gold: #ffd700;
        }

        * { box-sizing: border-box; }

        body { 
            margin: 0; 
            background: radial-gradient(circle at center, #1a1a24 0%, #000000 100%);
            color: var(--text-main); 
            font-family: 'Exo 2', sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            height: 100vh; 
            overflow: hidden; 
            user-select: none; 
        }

        /* --- Î∞∞Í≤Ω Ïû•Ïãù --- */
        body::before {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(rgba(0, 242, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 242, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: -1;
        }
        
        /* --- Ìó§Îçî --- */
        header { margin-top: 40px; margin-bottom: 20px; text-align: center; z-index: 10; }
        h1 { 
            font-family: 'Orbitron'; font-size: 50px; font-weight: 900; margin: 0; 
            color: #fff; text-shadow: 0 0 10px var(--accent), 0 0 30px var(--accent); letter-spacing: 2px;
        }
        .subtitle { font-family: 'Orbitron'; color: var(--accent); letter-spacing: 8px; font-size: 14px; margin-top: 5px; opacity: 0.8; }
        
        /* --- ÏÉÅÎã® Î≤ÑÌäº --- */
        .top-right-group { position: absolute; top: 30px; right: 40px; display: flex; gap: 15px; align-items: center; z-index: 100; }
        .btn-icon {
            width: 45px; height: 45px; border-radius: 50%;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2);
            color: #fff; font-size: 20px; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            transition: all 0.3s ease; backdrop-filter: blur(5px);
        }
        .btn-icon:hover { border-color: var(--accent); color: var(--accent); box-shadow: 0 0 15px var(--accent-glow); transform: rotate(90deg); }

        .btn-create { 
            text-decoration: none; color: #fff; font-family: 'Orbitron'; font-size: 13px; font-weight: bold;
            border: 1px solid var(--accent); padding: 10px 24px; border-radius: 30px; 
            transition: 0.3s; background: rgba(0, 242, 255, 0.1); backdrop-filter: blur(5px);
            display: flex; align-items: center; gap: 8px;
        }
        .btn-create:hover { background: var(--accent); color: #000; box-shadow: 0 0 20px var(--accent-glow); }

        /* --- ÌîÑÎ°úÌïÑ Ïπ¥Îìú --- */
        .profile-card {
            position: absolute; top: 30px; left: 40px;
            display: flex; flex-direction: column; gap: 6px;
            font-family: 'Orbitron'; z-index: 100;
            background: rgba(0,0,0,0.6); padding: 15px;
            border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }
        .lv-label { font-size: 24px; color: var(--gold); font-weight: 900; text-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
        .xp-bar-bg { width: 180px; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
        .xp-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #fff); width: 0%; transition: width 1s ease-out; }
        .xp-text { font-size: 11px; color: #aaa; margin-top: 2px; text-align: right; }
        
        .nickname-container { display: flex; align-items: center; gap: 10px; }
        #user-name-display { font-size: 14px; color: #fff; font-weight: bold; }
        .btn-edit-nick { background: none; border: none; cursor: pointer; color: #666; font-size: 14px; transition: 0.2s; padding: 0; }
        .btn-edit-nick:hover { color: var(--accent); }

        .custom-login-btn {
            margin-top: 10px; padding: 8px 0; width: 100%;
            background: var(--accent); border: none;
            color: #000; font-family: 'Orbitron'; font-weight: bold;
            font-size: 12px; cursor: pointer; border-radius: 4px; transition: 0.2s;
        }
        .custom-login-btn:hover { box-shadow: 0 0 15px var(--accent-glow); filter: brightness(1.1); }
        .btn-logout { background: #ff0055; color: #fff; }
        .btn-logout:hover { box-shadow: 0 0 15px rgba(255, 0, 85, 0.6); }

        /* --- Í≥° Î¶¨Ïä§Ìä∏ Í∑∏Î¶¨Îìú --- */
        .song-container {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px;
            width: 85%; max-width: 1200px; height: calc(100vh - 180px);
            padding: 20px 20px 50px 20px; overflow-y: auto; overflow-x: hidden; margin-top: 10px;
        }
        .song-container::-webkit-scrollbar { width: 6px; }
        .song-container::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 3px; }
        .song-container::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        .song-container::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* Ïπ¥Îìú Ïä§ÌÉÄÏùº */
        .song-card {
            background: rgba(20, 20, 25, 0.6); border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px; padding: 15px; display: flex; flex-direction: column;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); position: relative;
            backdrop-filter: blur(10px); overflow: hidden; height: 480px;
        }
        .song-card:hover { transform: translateY(-5px) scale(1.02); border-color: var(--accent); box-shadow: 0 10px 30px -10px var(--accent-glow); z-index: 5; background: rgba(20, 20, 25, 0.9); }

        .card-cover {
            width: 100%; height: 180px; background: #0a0a0c; display: flex; align-items: center; justify-content: center;
            font-size: 60px; border-radius: 8px; margin-bottom: 15px; color: #333; border: 1px solid #333; position: relative; overflow: hidden;
        }
        .card-cover::after { content: ""; position: absolute; top:0; left:0; width:100%; height:100%; background: linear-gradient(to bottom, transparent, rgba(0,0,0,0.5)); }

        .card-info { flex: 1; display: flex; flex-direction: column; width: 100%; }
        .card-title { font-family: 'Exo 2', sans-serif; font-size: 20px; font-weight: 700; color: #fff; margin-bottom: 5px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; height: 50px; line-height: 1.25; }
        .card-artist { color: var(--text-dim); font-size: 13px; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .diff-box { display: flex; flex-direction: column; gap: 8px; overflow-y: auto; flex: 1; padding-right: 5px; }
        .diff-box::-webkit-scrollbar { width: 4px; }
        .diff-box::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        .btn-diff {
            width: 100%; padding: 10px 12px; border: none; border-radius: 6px; cursor: pointer;
            font-weight: bold; font-family: 'Orbitron'; font-size: 12px;
            display: flex; justify-content: space-between; align-items: center;
            transition: 0.2s; position: relative; overflow: hidden;
        }
        .btn-diff::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0) 100%); transform: skewX(-20deg) translateX(-150%); transition: 0.5s; }
        .btn-diff:hover::before { transform: skewX(-20deg) translateX(150%); }
        .btn-diff:hover { transform: translateX(5px); filter: brightness(1.2); }

        .btn-diff.normal { background: linear-gradient(135deg, #00b4db 0%, #0083b0 100%); color: white; }
        .btn-diff.hard { background: linear-gradient(135deg, #bc4e9c 0%, #f80759 100%); color: white; }
        .btn-diff.troll { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; }

        .score-badge { background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 4px; font-size: 11px; display: flex; align-items: center; gap: 4px; }
        .btn-rank-icon { width: 36px; height: 36px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: var(--gold); display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; margin-left: 8px; }
        .btn-rank-icon:hover { background: var(--gold); color: #000; border-color: var(--gold); }

        .status-msg { grid-column: 1 / -1; text-align: center; margin-top: 100px; font-size: 24px; color: var(--accent); font-family: 'Orbitron'; animation: pulse 1.5s infinite; }

        /* --- Í≥µÌÜµ Î™®Îã¨ --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(8px); animation: fadeIn 0.3s; }
        .modal-box { background: #121216; border: 1px solid #333; border-radius: 16px; padding: 40px; box-shadow: 0 0 60px rgba(0,0,0,0.8); text-align: center; min-width: 400px; position: relative; }
        .modal-title { font-family: 'Orbitron'; font-size: 24px; color: var(--accent); margin-bottom: 30px; letter-spacing: 2px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .modal-close { position: absolute; top: 20px; right: 20px; background: none; border: none; color: #666; font-size: 24px; cursor: pointer; }
        .modal-close:hover { color: #fff; }

        /* ÏÑ§Ï†ïÏ∞Ω */
        .setting-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; font-family: 'Orbitron'; color: #ccc; font-size: 14px; }
        .setting-val { color: var(--accent); font-weight: bold; width: 60px; text-align: right; }
        input[type="range"] { accent-color: var(--accent); cursor: pointer; width: 180px; }

        /* ‚òÖ ÌÇ§ Î∞îÏù∏Îî© Ïä§ÌÉÄÏùº */
        .key-bind-container { display: flex; gap: 10px; }
        .key-btn { 
            width: 50px; height: 50px; border: 2px solid #444; border-radius: 8px; 
            background: #222; color: #fff; font-family: 'Orbitron'; font-weight: bold; font-size: 18px;
            cursor: pointer; transition: 0.2s; text-transform: uppercase;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .key-btn:hover { border-color: var(--accent); color: var(--accent); }
        .key-btn.listening { border-color: var(--gold); color: var(--gold); animation: pulse 0.5s infinite; }
        
        /* ÌôïÏù∏ Î™®Îìú Î≤ÑÌäº */
        .key-confirm-box { display: flex; gap: 5px; margin-top: 5px; }
        .btn-confirm { width: 20px; height: 20px; font-size: 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-confirm.yes { background: #00e676; color: #000; }
        .btn-confirm.no { background: #ff0055; color: #fff; }

        .btn-full { width: 100%; padding: 14px; margin-top: 15px; background: #222; border: 1px solid #444; color: var(--accent); font-family: 'Orbitron'; font-weight: bold; cursor: pointer; border-radius: 8px; transition: 0.2s; }
        .btn-full:hover { background: #333; border-color: var(--accent); }

        /* Îû≠ÌÇπ Î¶¨Ïä§Ìä∏ */
        .rank-list { max-height: 400px; overflow-y: auto; text-align: left; padding: 0 10px; }
        .rank-item { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.03); margin-bottom: 8px; padding: 12px 15px; border-radius: 8px; font-family: 'Exo 2'; border: 1px solid transparent; }
        .rank-item:hover { border-color: var(--accent); background: rgba(0, 242, 255, 0.05); }
        .rank-rank { width: 40px; font-family: 'Orbitron'; font-weight: bold; color: #666; font-size: 18px; }
        .rank-rank.top1 { color: #ffd700; font-size: 22px; text-shadow: 0 0 10px rgba(255,215,0,0.5); }
        .rank-rank.top2 { color: #c0c0c0; }
        .rank-rank.top3 { color: #cd7f32; }
        .rank-name { font-weight: 600; color: #eee; flex:1; }
        .rank-score { font-family: 'Orbitron'; font-weight: bold; color: #fff; letter-spacing: 1px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }

        /* Ïã±ÌÅ¨ Ï°∞Ï†à Ïò§Î≤ÑÎ†àÏù¥ */
        .calib-circle { width: 150px; height: 150px; border-radius: 50%; border: 2px solid var(--accent); display: flex; align-items: center; justify-content: center; font-size: 20px; color: var(--accent); font-family: 'Orbitron'; cursor: pointer; transition: 0.1s; box-shadow: 0 0 20px var(--accent-glow); margin: 0 auto 30px; }
        .calib-circle:active { transform: scale(0.9); background: var(--accent); color: #000; }
        .calib-circle.flash { background: #fff; box-shadow: 0 0 50px #fff; }

        /* ÎãâÎÑ§ÏûÑ ÏûÖÎ†• */
        .modal-input { background: transparent; border: none; border-bottom: 2px solid var(--accent); color: #fff; font-size: 24px; font-family: 'Orbitron'; text-align: center; width: 100%; outline: none; padding: 10px; margin: 20px 0; }

        /* ÌÇ§ Î∞îÏù∏Îî© Ïò§Î≤ÑÎ†àÏù¥ (ÌôîÎ©¥ Ï†ÑÏ≤¥ ÎçÆÎäî) */
        #key-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 10; border-radius: 16px;
            flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

    <div class="profile-card" id="profile-container" style="display:none;">
        <div class="lv-label" id="user-lv">LV. 1</div>
        <div class="xp-bar-bg"><div class="xp-bar-fill" id="user-xp-fill"></div></div>
        <div class="xp-text" id="user-xp-text">0 / 500 XP</div>
        <div class="nickname-container" style="margin-top:8px;">
            <div id="user-name-display">GUEST MODE</div>
            <button id="btn-edit-nick" class="btn-edit-nick" onclick="openNicknameModal(true)" style="display:none;">‚úèÔ∏è</button>
        </div>
        <button id="main-login-btn" class="custom-login-btn" onclick="handleAuth()">LOGIN</button>
    </div>

    <div class="top-right-group">
        <button class="btn-icon" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
        <a href="game_editor.html" class="btn-create" title="Create Chart"><span>üõ†</span> CREATE</a>
    </div>

    <header>
        <h1>ARCADE SELECT</h1>
        <div class="subtitle">CHOOSE YOUR STAGE</div>
    </header>

    <div class="song-container" id="song-list">
        <div class="status-msg">LOADING SYSTEM...</div>
    </div>

    <div id="settings-modal" class="modal-overlay" onclick="closeSettings(event)">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div class="modal-title">SYSTEM SETTINGS</div>
            
            <div class="setting-row">
                <span>NOTE SPEED</span>
                <input type="range" id="speed-slider" min="1.0" max="20.0" step="0.1" value="5.0">
                <span class="setting-val" id="speed-display">5.0</span>
            </div>

            <div class="setting-row">
                <span>SFX VOLUME</span>
                <input type="range" id="sfx-volume" min="0" max="1" step="0.1" value="0.7">
                <span class="setting-val" id="sfx-val">70%</span>
            </div>

            <div class="setting-row">
                <span>GEAR OPACITY</span>
                <input type="range" id="opacity-slider" min="0" max="100" step="5" value="70">
                <span class="setting-val" id="opacity-val">70%</span>
            </div>

            <div class="setting-row">
                <span>AUDIO OFFSET</span>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span class="setting-val" id="offset-display" style="width:auto;">0</span> ms
                </div>
            </div>

            <div class="setting-row">
                <span>KEY CONFIG</span>
                <div class="key-bind-container" id="key-bind-group">
                    </div>
            </div>

            <button class="btn-full" onclick="openCalib()">üîä SYNC WIZARD</button>
            <button class="btn-full" onclick="closeSettings()" style="background:#444; color:#fff; margin-top:10px;">CLOSE</button>
            
            <div id="key-overlay">
                <div style="font-family:'Orbitron'; font-size:20px; color:#fff; margin-bottom:20px;" id="key-msg">PRESS KEY...</div>
                <div id="key-confirm-btns" style="display:none; gap:20px;">
                    <button class="btn-icon" style="border-color:#00e676; color:#00e676;" onclick="confirmKey(true)">‚úî</button>
                    <button class="btn-icon" style="border-color:#ff0055; color:#ff0055;" onclick="confirmKey(false)">‚úñ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="name-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">IDENTITY SETUP</div>
            <p style="color:#888;">Please register your nickname.</p>
            <input type="text" id="nickname-input" class="modal-input" placeholder="ENTER NAME" maxlength="12">
            <button class="btn-full" onclick="saveNicknameToServer()">CONFIRM</button>
        </div>
    </div>

    <div id="rank-modal" class="modal-overlay" onclick="closeRank(event)">
        <div class="modal-box" style="width: 500px;" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeRank()">√ó</button>
            <div class="modal-title" id="rank-title">RANKING</div>
            <div class="rank-list" id="rank-list-container">
                <div style="text-align:center; padding:30px; color:#666;">LOADING DATA...</div>
            </div>
        </div>
    </div>

    <div id="calib-overlay" class="modal-overlay" style="z-index:3000;">
        <div class="modal-box" style="background:rgba(0,0,0,0.95); width:500px;">
            <h2 style="font-family:'Orbitron'; color:var(--accent); margin-bottom:40px;">AUDIO SYNC</h2>
            <div id="calib-circle" class="calib-circle" onclick="handleTap(event)">TAP</div>
            <div id="calib-msg" style="color:#aaa; margin-bottom:20px;">Listen to the beat and tap!</div>
            <div style="display:flex; justify-content:center; gap:15px; margin-bottom:20px;">
                <button class="btn-icon" onclick="adjustOffset(-1)">-</button>
                <input type="number" id="offset-input" value="0" onchange="manualInput()" style="background:transparent; border:none; color:#fff; font-size:24px; width:80px; text-align:center; font-family:'Orbitron';">
                <button class="btn-icon" onclick="adjustOffset(1)">+</button>
            </div>
            <button class="btn-full" onclick="closeCalib()">SAVE & EXIT</button>
        </div>
    </div>

    <script>
        const API_BASE = "https://port-0-vibecoding-rhythmgame-server-mkgu8rcq7cd54e6c.sel3.cloudtype.app"; 

        window.onload = function() {
            initSettings();
            initKeyBindings(); // ‚òÖ ÌÇ§ ÏÑ§Ï†ï Ï¥àÍ∏∞Ìôî
            checkLoginStatus(); 
            const justLoggedIn = localStorage.getItem('wb_just_logged_in');
            if (justLoggedIn === 'true') {
                openNicknameModal(true);
                localStorage.removeItem('wb_just_logged_in'); 
            }
        };

        // ... [ÎãâÎÑ§ÏûÑ, Î°úÍ∑∏Ïù∏, ÌîÑÎ°úÌïÑ Í¥ÄÎ†® Ìï®ÏàòÎì§ (Í∏∞Ï°¥ ÎèôÏùº)] ...
        function openNicknameModal(forceOpen) { if (!forceOpen && localStorage.getItem('wb_nickname')) { checkLoginStatus(); return; } const modal = document.getElementById('name-modal'); const input = document.getElementById('nickname-input'); const googleProfile = JSON.parse(localStorage.getItem('wb_auth_profile') || '{}'); const currentNick = localStorage.getItem('wb_nickname'); input.value = currentNick || googleProfile.name || ""; modal.style.display = 'flex'; }
        async function saveNicknameToServer() { const input = document.getElementById('nickname-input'); const newNickname = input.value.trim(); if (newNickname.length < 2 || newNickname.length > 12) { alert("2~12Í∏ÄÏûê ÏÇ¨Ïù¥Î°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî."); return; } localStorage.setItem('wb_nickname', newNickname); const profile = JSON.parse(localStorage.getItem('wb_auth_profile') || '{}'); if (profile.sub) { try { await fetch(`${API_BASE}/api/user/update`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: profile.sub, nickname: newNickname }) }); } catch (e) { console.error(e); } } document.getElementById('name-modal').style.display = 'none'; checkLoginStatus(); alert(`ÌôòÏòÅÌï©ÎãàÎã§, [${newNickname}]Îãò!`); }
        function checkLoginStatus() { const btn = document.getElementById('main-login-btn'); const profileContainer = document.getElementById('profile-container'); const nameDisplay = document.getElementById('user-name-display'); const editBtn = document.getElementById('btn-edit-nick'); const isLoggedIn = localStorage.getItem('wb_logged_in') === 'true'; if (isLoggedIn) { if(btn) { btn.innerText = "LOGOUT"; btn.classList.add('btn-logout'); btn.onclick = handleAuth; } profileContainer.style.display = "flex"; const nick = localStorage.getItem('wb_nickname'); if(nameDisplay) { nameDisplay.innerText = nick ? nick : "PLAYER"; nameDisplay.style.color = "#00e5ff"; } if(editBtn) editBtn.style.display = "block"; updateProfile(); } else { if(btn) { btn.innerText = "LOGIN"; btn.classList.remove('btn-logout'); btn.onclick = handleAuth; } profileContainer.style.display = "flex"; if(nameDisplay) { nameDisplay.innerText = "GUEST MODE"; nameDisplay.style.color = "#888"; } if(editBtn) editBtn.style.display = "none"; } }
        function handleAuth() { const isLoggedIn = localStorage.getItem('wb_logged_in') === 'true'; if (isLoggedIn) { if(confirm("Î°úÍ∑∏ÏïÑÏõÉ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) { localStorage.clear(); location.reload(); } } else { location.href = 'login.html'; } }
        function updateProfile() { const lv = parseInt(localStorage.getItem('wb_user_lv') || "1"); const xp = parseInt(localStorage.getItem('wb_user_xp') || "0"); const nextXp = lv * 500; document.getElementById('user-lv').innerText = `LV. ${lv}`; document.getElementById('user-xp-fill').style.width = `${Math.min(100, xp/nextXp*100)}%`; document.getElementById('user-xp-text').innerText = `${xp} / ${nextXp} XP`; }

        // --- ÏÑ§Ï†ïÏ∞Ω Î≥ÄÏàò ---
        const settingsModal = document.getElementById('settings-modal');
        const speedSlider = document.getElementById('speed-slider');
        const speedDisplay = document.getElementById('speed-display');
        const sfxSlider = document.getElementById('sfx-volume');
        const sfxVal = document.getElementById('sfx-val');
        const opacitySlider = document.getElementById('opacity-slider');
        const opacityVal = document.getElementById('opacity-val');
        const offsetDisplay = document.getElementById('offset-display');

        function openSettings() { settingsModal.style.display = 'flex'; offsetDisplay.innerText = localStorage.getItem('wb_global_offset') || 0; }
        function closeSettings(e) { if (e && e.target !== settingsModal && !e.target.classList.contains('btn-full')) return; settingsModal.style.display = 'none'; }
        
        function initSettings() {
            const savedSpeed = localStorage.getItem('wb_user_speed') || "5.0";
            if(speedSlider) { speedSlider.value = savedSpeed; speedDisplay.innerText = parseFloat(savedSpeed).toFixed(1); }
            const savedVol = localStorage.getItem('wb_sfx_volume') || "0.7";
            if(sfxSlider) { sfxSlider.value = savedVol; sfxVal.innerText = Math.round(savedVol * 100) + "%"; }
            const savedOpacity = localStorage.getItem('wb_gear_opacity') || "70";
            if(opacitySlider) { opacitySlider.value = savedOpacity; opacityVal.innerText = savedOpacity + "%"; }
        }
        
        speedSlider.addEventListener('input', (e) => { const val = parseFloat(e.target.value).toFixed(1); speedDisplay.innerText = val; localStorage.setItem('wb_user_speed', val); });
        sfxSlider.addEventListener('input', (e) => { const vol = e.target.value; sfxVal.innerText = Math.round(vol * 100) + "%"; localStorage.setItem('wb_sfx_volume', vol); });
        if(opacitySlider) { opacitySlider.addEventListener('input', (e) => { const val = e.target.value; opacityVal.innerText = val + "%"; localStorage.setItem('wb_gear_opacity', val); }); }

        // ==========================================
        // ‚òÖ [KEY BINDING LOGIC] ‚òÖ
        // ==========================================
        let currentKeys = JSON.parse(localStorage.getItem('wb_key_layout')) || ['d', 'f', 'j', 'k'];
        let bindingIndex = -1; // ÌòÑÏû¨ Î∞îÏù∏Îî© Ï§ëÏù∏ ÌÇ§ Ïù∏Îç±Ïä§ (0~3)
        let tempKey = ""; // ÏûÑÏãúÎ°ú ÎàåÎ¶∞ ÌÇ§

        function initKeyBindings() {
            const container = document.getElementById('key-bind-group');
            container.innerHTML = ""; // Ï¥àÍ∏∞Ìôî
            currentKeys.forEach((key, idx) => {
                const btn = document.createElement('button');
                btn.className = 'key-btn';
                btn.innerText = key.toUpperCase();
                btn.onclick = () => startBinding(idx);
                container.appendChild(btn);
            });
        }

        function startBinding(idx) {
            bindingIndex = idx;
            const overlay = document.getElementById('key-overlay');
            const msg = document.getElementById('key-msg');
            const btns = document.getElementById('key-confirm-btns');
            
            overlay.style.display = 'flex';
            msg.innerText = "PRESS ANY KEY...";
            msg.style.color = "#fff";
            btns.style.display = 'none'; // ÌôïÏù∏ Î≤ÑÌäº Ïà®ÍπÄ

            // ÌÇ§ ÏûÖÎ†• ÎåÄÍ∏∞
            window.addEventListener('keydown', handleKeyInput);
        }

        function handleKeyInput(e) {
            e.preventDefault();
            // ÌäπÏàòÌÇ§ Î∞©ÏßÄ (ESCÎäî Ï∑®ÏÜåÏö©)
            if (e.key === "Escape") {
                cancelBinding();
                return;
            }
            
            tempKey = e.key.toLowerCase(); // ÏÜåÎ¨∏ÏûêÎ°ú Ï†ÄÏû• (Ïòà: 'a', 'ArrowUp')
            
            // UI ÏóÖÎç∞Ïù¥Ìä∏: ÌôïÏù∏ ÏöîÏ≤≠
            const msg = document.getElementById('key-msg');
            const btns = document.getElementById('key-confirm-btns');
            
            let displayKey = tempKey.toUpperCase();
            if(displayKey === " ") displayKey = "SPACE";

            msg.innerHTML = `SET TO <span style="color:#00e5ff; font-weight:bold;">[ ${displayKey} ]</span> ?`;
            btns.style.display = 'flex'; // Î≤ÑÌäº Î≥¥Ïù¥Í∏∞

            // Î¶¨Ïä§ÎÑà Ï†úÍ±∞ (Ï§ëÎ≥µ ÏûÖÎ†• Î∞©ÏßÄ)
            window.removeEventListener('keydown', handleKeyInput);
        }

        function confirmKey(isYes) {
            if (isYes && bindingIndex !== -1) {
                currentKeys[bindingIndex] = tempKey;
                localStorage.setItem('wb_key_layout', JSON.stringify(currentKeys)); // Ï†ÄÏû•
                initKeyBindings(); // UI Í∞±Ïã†
            }
            cancelBinding(); // Îã´Í∏∞
        }

        function cancelBinding() {
            bindingIndex = -1;
            tempKey = "";
            document.getElementById('key-overlay').style.display = 'none';
            window.removeEventListener('keydown', handleKeyInput);
        }
        // ==========================================

        // --- Í≥° Î™©Î°ù Î°úÎî© (Í∏∞Ï°¥) ---
        window.addEventListener('DOMContentLoaded', async () => {
            const list = document.getElementById('song-list');
            if(!list) return;
            try {
                const response = await fetch('song_list.json?t=' + new Date().getTime());
                const songs = await response.json();
                list.innerHTML = ""; 
                songs.forEach(song => {
                    const diffs = [];
                    song.charts.forEach(filename => {
                        const lower = filename.toLowerCase();
                        let type = lower.includes('normal') ? 'normal' : lower.includes('hard') ? 'hard' : lower.includes('troll') ? 'troll' : '';
                        if (type) {
                            const level = filename.match(/_(\d+)\.json$/)?.[1];
                            diffs.push({ type, level: parseInt(level||0), levelRaw: level, fileKey: filename.replace(/\.json$/i, '') });
                        }
                    });
                    const typeOrder = { 'normal': 1, 'hard': 2, 'troll': 3 };
                    diffs.sort((a, b) => (typeOrder[a.type] - typeOrder[b.type]) || (a.level - b.level));
                    const card = document.createElement('div');
                    card.className = 'song-card';
                    let diffButtons = '';
                    diffs.forEach(d => {
                        const score = localStorage.getItem(`wb_score_${song.folder}_${d.fileKey}`) || '000000';
                        const badge = localStorage.getItem(`wb_badge_${song.folder}_${d.fileKey}`);
                        let badgeHtml = badge === "TB" ? "<span style='color:#d500f9'>üëë</span>" : (badge === "FC" ? "<span style='color:#00e5ff'>‚òÖ</span>" : "");
                        diffButtons += `
                            <div style="display:flex; align-items:center; width:100%;">
                                <button class="btn-diff ${d.type}" style="flex:1;" onclick="play('${song.folder}', '${d.fileKey}')">
                                    <div style="display:flex; align-items:center; gap:8px;"><span>${d.type.toUpperCase()}</span> ${d.levelRaw ? `<span style="background:rgba(0,0,0,0.3); padding:2px 5px; border-radius:4px; font-size:10px;">Lv.${d.levelRaw}</span>` : ''}</div>
                                    <div class="score-badge">üèÜ ${score} ${badgeHtml}</div>
                                </button>
                                <button class="btn-rank-icon" onclick="openRanking('${song.folder}', '${d.fileKey}', '${song.title}', '${d.type}')">üëë</button>
                            </div>`;
                    });
                    card.innerHTML = `<div class="card-cover">üéµ</div><div class="card-info"><div class="card-title">${song.title}</div><div class="card-artist">${song.artist}</div><div class="diff-box">${diffButtons}</div></div>`;
                    list.appendChild(card);
                });
            } catch (e) { list.innerHTML = `<div class="status-msg" style="color:#ff5555; grid-column:1/-1;">SERVER CONNECTION FAILED</div>`; }
        });
        function play(folder, fileKey) { window.location.href = `game.html?song=${encodeURIComponent(folder)}&diff=${fileKey}&speed=${speedSlider.value}`; }
        
        // --- Îû≠ÌÇπ ---
        const rankModal = document.getElementById('rank-modal'); const rankList = document.getElementById('rank-list-container'); const rankHeader = document.getElementById('rank-title');
        async function openRanking(songFolder, diffKey, title, type) { rankModal.style.display = 'flex'; rankHeader.innerText = `${title} [${type.toUpperCase()}]`; rankList.innerHTML = `<div style="text-align:center; padding:30px; color:#00e5ff; animation:pulse 1s infinite;">FETCHING DATA...</div>`; try { const res = await fetch(`${API_BASE}/api/ranking/${songFolder}/${diffKey}`); const data = await res.json(); if (data.length === 0) { rankList.innerHTML = `<div style="text-align:center; padding:40px; color:#666;">NO RECORDS FOUND</div>`; return; } let html = ""; data.forEach((user, idx) => { const rank = idx + 1; let rankClass = rank === 1 ? "top1" : (rank === 2 ? "top2" : (rank === 3 ? "top3" : "")); const lv = user.level ? `LV. ${user.level}` : ""; html += `<div class="rank-item"><div class="rank-rank ${rankClass}">#${rank}</div><div class="rank-name">${user.userName} <span style="font-size:10px; color:#00e5ff; margin-left:5px;">${lv}</span></div><div class="rank-score">${user.score.toLocaleString()}</div></div>`; }); rankList.innerHTML = html; } catch (e) { rankList.innerHTML = `<div style="text-align:center; color:#ff5555; padding:20px;">NETWORK ERROR</div>`; } }
        function closeRank(e) { if (e && e.target !== rankModal && e.target.className !== 'modal-close') return; rankModal.style.display = 'none'; }
        document.getElementById('rank-modal').addEventListener('click', (e) => { if (e.target.id === 'rank-modal') closeRank(); });

        // --- Ïã±ÌÅ¨ ---
        let audioCtx; let calibInterval; let nextBeatTime = 0; const BPM = 120; const INTERVAL_SEC = 60 / BPM; let tapDiffs = []; let isCalibrating = false;
        function openCalib() { settingsModal.style.display = 'none'; document.getElementById('calib-overlay').style.display = 'flex'; document.getElementById('offset-input').value = localStorage.getItem('wb_global_offset') || 0; document.getElementById('calib-msg').innerText = "Click circle to start test"; tapDiffs = []; isCalibrating = false; }
        function closeCalib() { document.getElementById('calib-overlay').style.display = 'none'; stopCalib(); openSettings(); }
        function manualInput() { const val = document.getElementById('offset-input').value; localStorage.setItem('wb_global_offset', val); offsetDisplay.innerText = val; }
        function adjustOffset(amount) { const input = document.getElementById('offset-input'); input.value = parseInt(input.value) + amount; manualInput(); }
        function startCalib() { if(isCalibrating) return; isCalibrating = true; tapDiffs = []; document.getElementById('calib-msg').innerText = "Listen & Tap to the beat!"; if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume(); nextBeatTime = audioCtx.currentTime + 0.5; scheduleBeep(); }
        function stopCalib() { clearTimeout(calibInterval); isCalibrating = false; }
        function scheduleBeep() { if(!isCalibrating) return; const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination); osc.frequency.value = 1000; gain.gain.value = 0.1; osc.start(nextBeatTime); osc.stop(nextBeatTime + 0.05); const delay = (nextBeatTime - audioCtx.currentTime) * 1000; setTimeout(() => { const circle = document.getElementById('calib-circle'); circle.classList.add('flash'); setTimeout(() => circle.classList.remove('flash'), 50); }, delay); nextBeatTime += INTERVAL_SEC; calibInterval = setTimeout(scheduleBeep, delay + 200); }
        function handleTap(e) { if(e && (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON')) return; if (!isCalibrating) { startCalib(); return; } const tapTime = audioCtx.currentTime; const timeFromPrev = (tapTime - (nextBeatTime - INTERVAL_SEC)); const timeToNext = (nextBeatTime - tapTime); let diff = (Math.abs(timeFromPrev) < Math.abs(timeToNext)) ? timeFromPrev : -timeToNext; if(Math.abs(diff) < 0.2) { tapDiffs.push(diff * 1000); const circle = document.getElementById('calib-circle'); circle.style.transform = "scale(0.9)"; setTimeout(() => circle.style.transform = "scale(1)", 100); const currentAvg = Math.round(tapDiffs.reduce((a,b)=>a+b, 0) / tapDiffs.length); document.getElementById('offset-input').value = currentAvg; manualInput(); if(tapDiffs.length >= 8) { stopCalib(); document.getElementById('calib-msg').innerHTML = "<span style='color:#00e5ff; font-weight:bold;'>SYNC COMPLETE!</span>"; } } }
        window.addEventListener('keydown', (e) => { if(e.code === 'Space' && document.getElementById('calib-overlay').style.display === 'flex') handleTap(); });
    </script>
</body>
</html>